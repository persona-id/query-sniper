services:
  app:
    build:
      dockerfile: build/dev.Dockerfile
    cap_add:
      - SYS_PTRACE
    depends_on:
      - dev-db-primary
      - dev-db-replica0
      - dev-db-replica1
    environment:
      - MYSQL_PS1=\u@\h>\_
    security_opt:
      - seccomp:unconfined
    volumes:
      - .:/workspace:cached
      - ./.devcontainer/certs:/etc/mysql/certs

  dev-db-primary:
    image: mysql:8.0.36
    container_name: dev-db-primary
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=web-us1
      - MYSQL_USER=replication
      - MYSQL_PASSWORD=replication
    command:
      - --server-id=1
      - --ssl=1
      - --ssl-ca=/etc/mysql/certs/ca.crt
      - --ssl-cert=/etc/mysql/certs/mysql.crt
      - --ssl-key=/etc/mysql/certs/mysql.key
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --log-bin=mysql-bin
      - --binlog-format=row
    tmpfs:
      - /var/lib/mysql
    volumes:
        - ./.devcontainer/certs:/etc/mysql/certs

  dev-db-replica0:
    image: mysql:8.0.36
    container_name: dev-db-replica0
    depends_on:
      - dev-db-primary
    environment:
      - MYSQL_ROOT_PASSWORD=root
    command:
      - --server-id=2
      - --ssl=1
      - --ssl-ca=/etc/mysql/certs/ca.crt
      - --ssl-cert=/etc/mysql/certs/mysql.crt
      - --ssl-key=/etc/mysql/certs/mysql.key
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --log-bin=mysql-bin
      - --binlog-format=row
      - --read-only
    tmpfs:
      - /var/lib/mysql
    volumes:
      - ./.devcontainer/certs:/etc/mysql/certs

  dev-db-replica1:
    image: mysql:8.0.36
    container_name: dev-db-replica1
    depends_on:
      - dev-db-primary
    environment:
      - MYSQL_ROOT_PASSWORD=root
    command:
      - --server-id=3
      - --ssl=1
      - --ssl-ca=/etc/mysql/certs/ca.crt
      - --ssl-cert=/etc/mysql/certs/mysql.crt
      - --ssl-key=/etc/mysql/certs/mysql.key
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --log-bin=mysql-bin
      - --binlog-format=row
      - --read-only
    tmpfs:
      - /var/lib/mysql
    volumes:
      - ./.devcontainer/certs:/etc/mysql/certs

  cert-gen:
    image: alpine
    volumes:
      - ./.devcontainer/certs:/certs
    entrypoint:
      - /bin/sh
      - -c
      - |
        apk add --no-cache openssl &&
        # Generate CA key and certificate first
        openssl genpkey -algorithm RSA -out /certs/ca.key -pkeyopt rsa_keygen_bits:2048 &&
        openssl req -new -x509 -key /certs/ca.key -out /certs/ca.crt -days 1095 -subj "/CN=Certificate Authority/O=myorg/C=US" &&
        # Generate server key and CSR
        openssl genpkey -algorithm RSA -out /certs/mysql.key -pkeyopt rsa_keygen_bits:2048 &&
        openssl req -new -key /certs/mysql.key -out /certs/mysql.csr -subj "/CN=mysql/O=myorg/C=US" &&
        # Sign the server certificate with the CA
        openssl x509 -req -in /certs/mysql.csr -CA /certs/ca.crt -CAkey /certs/ca.key -CAcreateserial -out /certs/mysql.crt -days 365 &&
        chmod 600 /certs/* && chown 999:999 /certs/*
    restart: "no"
